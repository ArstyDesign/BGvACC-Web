<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/springsecurity"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{templates/mainTemplate}">
  <head>
    <title th:text="#{app.title(${event.name})}">BGvACC</title>

    <meta name="title" th:content="${event.name}" />
    <meta name="description" th:content="${event.shortDescription}" />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" th:content="${fullUrl}" />
    <meta property="og:title" th:content="${event.name}" />
    <meta property="og:description" th:content="${event.shortDescription}" />
    <meta property="og:image" th:content="${event.imageUrl}" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" th:content="${fullUrl}" />
    <meta property="twitter:title" th:content="${event.name}" />
    <meta property="twitter:description" th:content="${event.shortDescription}" />
    <meta property="twitter:image" th:content="${event.imageUrl}" />

    <style>
      .eventDescription a {
        color: var(--bs-primary) !important;
      }
    </style>
  </head>
  <body>
    <div layout:fragment="contentDiv">

      <!--Card-->
      <div class="card shadow border-0 mb-4">
        <div class="d-flex flex-lg-row flex-column overflow-hidden ">
          <div class="">
            <!--Image-->
            <img src="#" th:src="${event.imageUrl}" alt="" class="img-fluid border rounded"/>
          </div>
          <div class="card-body h-100 p-0 mt-0 m-4 flex-grow-1">
            <div class="my-4">
              <h1 class="h4 mb-2" th:text="${event.name}">Title</h1>
              <div class="lh-1 text-body-secondary" th:text="${event.getFormattedStartDateTime('dd.MM.yyyy, HH:mm')} + ' - ' + ${event.getFormattedEndDateTime('HH:mm')} + 'z'">Mar 12, 2021</div>
            </div>
            <div class="fs-5" th:text="${event.shortDescription}">Short description</div>
            <hr class="mt-3 mb-0 d-block d-lg-none"/>
          </div>
        </div>
        <div class="eventDescription mx-4 mb-4 mt-0 mt-lg-4">
          <div th:utext="${event.htmlDescription}">Description</div>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="h5 mb-3" th:text="#{event.roster.title}">Event roster</div>

          <div th:if="${event.isPast and !doAllPositionsHaveSlots}">
            <small class="bi bi-info-circle me-1"></small>
            <small th:text="#{event.roster.pastandnoconfig}">The event has already passed</small>
          </div>

          <div th:if="${!event.isPast}" th:remove="tag">
            <div th:if="${!event.isCpt and !doAllPositionsHaveSlots}" class="text-muted">
              <small class="bi bi-info-circle me-1"></small>
              <small th:text="#{event.roster.configuring}">The event roster is currently being configured. It will soon be available for booking.</small>
            </div>
          </div>

          <div th:if="${event.isCpt}" class="text-muted">
            <small class="bi bi-info-circle me-1"></small>
            <small th:text="#{event.roster.cpt}">The CPT events don't have a roster as they are connected to a parent event.</small>
          </div>

          <table class="table table-hover table-striped table-bordered align-middle mb-0" th:if="${doAllPositionsHaveSlots}">
            <thead>
              <tr>
                <th scope="col" class="fw-bold" th:text="#{event.roster.positionslot}">Position / Slot</th>
                <th scope="col" class="fw-bold text-center" th:each="sl : ${@slotsGenerator.generateSlots(event.startAt.toLocalDateTime(), event.endAt.toLocalDateTime(), mostSlots)}"
                    th:text="${sl.getFormattedStartDateTime('HH:mm')} + ' - ' + ${sl.getFormattedEndDateTime('HH:mm')} + 'z'"></th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="ep : ${eventPositions}">
                <td th:text="#{positions. + ${#strings.toLowerCase(ep.positionId)}}"></td>

                <td th:colspan="${mostSlots / #lists.size(ep.slots)}" class="text-center"
                    th:each="sl, iterStat : ${ep.slots}">

                  <div sec:authorize="isAuthenticated()" th:remove="tag">

                    <div th:if="${sl.isApproved}" th:remove="tag">
                      <div th:if="${sl.user ne null}" th:remove="tag">
                        <a href="#" th:href="@{/members/} + ${sl.user.cid}" target="_blank" th:if="${session.loggedUser.cid eq sl.user.cid}">
                          <strong th:text="${sl.user.names.fullName} + ' - ' + ${sl.user.cid}">John Doe</strong>
                        </a>
                        <a href="#" th:href="@{/members/} + ${sl.user.cid}" target="_blank" th:if="${session.loggedUser.cid ne sl.user.cid}">
                          <span th:text="${sl.user.names.fullName} + ' - ' + ${sl.user.cid}"></span>
                        </a>
                      </div>

                      <span th:if="${sl.user eq null}">-</span>
                    </div>

                    <div th:if="${!sl.isApproved}" th:remove="tag">
                      <span th:if="${sl.hasUserAlreadyApplied}" class="fst-italic" th:text="#{event.roster.alreadyapplied}">You already applied for slot</span>
                      <a href="#" th:if="${ep.canUserApplyForPosition and !sl.hasUserAlreadyApplied}" class="btn btn-primary btn-sm"
                         data-bs-toggle="modal"event.roster.applyforslot data-bs-target="#applyForSlotModal" th:data-slot-id="${sl.slotId}" 
                         th:data-msg="#{event.roster.applyforslot.modal.message(${event.name})}"
                         th:data-position="${ep.positionId}"
                         th:data-date="${event.getFormattedStartDateTime('dd.MM.yyyy')}"
                         th:data-time-slot="${sl.getFormattedStartDateTime('HH:mm')} + ' - ' + ${sl.getFormattedEndDateTime('HH:mm')} + 'z'"
                         th:text="#{event.roster.applyforslot}">Apply for slot</a>
                      <span th:if="${!ep.canUserApplyForPosition}" th:text="${sl.user != null ? sl.user.names.fullName : '-'}"></span>
                    </div>
                  </div>
                  <div sec:authorize="!isAuthenticated()" th:remove="tag">
                    <a href="#" th:href="@{/members/} + ${sl.user.cid}" target="_blank" th:if="${sl.isApproved}" th:text="${sl.user.names.fullName} + ' - ' + ${sl.user.cid}">John Doe</a>
                    <span th:if="${!sl.isApproved}">-</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal fade" id="applyForSlotModal" tabindex="-1" aria-labelledby="applyForSlotModalLabel" style="display: none;" aria-hidden="true">
        <form id="applyForSlotModalForm" method="post">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" th:text="#{event.roster.applyforslot.modal.title}">Application for event slot</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div id="applyForSlotMessage" class="mb-3"></div>
                <div>
                  <dl>
                    <dt th:text="#{event.roster.applyforslot.modal.eventdata.position}">Position</dt>
                    <dd id="applyForSlotDataPosition"></dd>
                    <dt th:text="#{event.roster.applyforslot.modal.eventdata.date}">Date</dt>
                    <dd id="applyForSlotDataDate"></dd>
                    <dt th:text="#{event.roster.applyforslot.modal.eventdata.timeslot}">Time slot</dt>
                    <dd id="applyForSlotDataTimeSlot"></dd>
                  </dl>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{event.roster.applyforslot.modal.eventdata.cancel}">Cancel</button>
                <button type="submit" class="btn btn-primary" th:text="#{event.roster.applyforslot.modal.eventdata.applyforslot}">Apply for slot</button>
              </div>
            </div>
          </div>
        </form>
      </div>

      <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        let applyForSlotUrl = /*[[@{/events/} + ${event.eventId} + '/slot']]*/;
                let applyForSlotUrl2 = /*[[@{/}]]*/;
        /*]]>*/

        document.getElementById('applyForSlotModal').addEventListener('show.bs.modal', function (event) {
          let modal = $(event.relatedTarget);
          let slotId = modal.data("slot-id");
          let message = modal.data("msg");
          let position = modal.data("position");
          let date = modal.data("date");
          let timeSlot = modal.data("time-slot");

          $("#applyForSlotMessage").empty().append(message);
          $("#applyForSlotDataPosition").empty().append(position);
          $("#applyForSlotDataDate").empty().append(date);
          $("#applyForSlotDataTimeSlot").empty().append(timeSlot);

          $('#applyForSlotModalForm').attr('action', applyForSlotUrl + '/' + slotId + '/apply-for-controlling');
        });

      </script>
    </div>
  </body>
</html>