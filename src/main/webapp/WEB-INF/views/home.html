<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{templates/mainTemplate}">
  <head>
    <title>Bulgaria vACC â€“ Bulgarian Virtual Area Control Center</title>
  </head>
  <body>
    <div layout:fragment="contentDiv">

      <div class="row">
        <div class="col-12 col-lg-9 mb-3">

          <span id="testttt"></span>

          <p th:utext="#{home.p1}">Welcome to the website of the Sofia FIR, a part of the BGvACC Regional Group on the <a href="https://vatsim.net">VATSIM</a> Network. Here you will find informations about how to become a controller within our vACC, and how to find and use all the necessary information about flying in the Bulgarian FIR.</p>

          <p th:utext="#{home.p2}">BGvACC is part of the <a href="http://vateud.net" target="_blank">VATSIM Europe Division</a>, which with <a href="https://www.vatsim-uk.co.uk" target="_blank">VATSIM UK</a> and <a href="http://www.vatrus.info" target="_blank">VATSIM Russia</a> form the <a href="http://www.vateur.org" target="_blank">VATSIM Europe Region</a>. This forms the European part of the global <a href="http://www.vatsim.net" target="_blank">VATSIM</a> network, which provides ATC services over the internet free of charge to pilots connected to this network using their flight simulator.</p>

          <p th:utext="#{home.p3}">Enjoy your stay in Sofia FIR!</p>

          <hr/>

          <div class="h5 mb-4" th:text="#{home.upcomingevents.title}">Upcoming events</div>

          <div th:if="${#lists.isEmpty(upcomingEvents)}" th:text="#{home.upcomingevents.notfound}">No upcoming events</div>

          <div class="row">
            <div class="col-12 col-xl-4 mb-3" th:each="e : ${upcomingEvents}">
              <article class="card shadow-sm hover-lift hover-shadow-lg rounded-3 h-100 overflow-hidden" th:classappend="${e.currentlyActive} ? 'border border-danger'">
                <a href="#" th:href="@{/events/} + ${e.eventId}" class="d-block overflow-hidden">
                  <div class="position-relative">
                    <img src="#" th:src="${e.imageUrl}" alt="" class="img-fluid w-100 img-zoom"/>
                    <div th:if="${e.currentlyActive}" class="position-absolute top-0 start-0 m-0 ps-2 d-flex">
                      <span class="btn btn-danger btn-sm py-0 px-2" style="border-radius: 0 0 0.25rem 0.25rem !important;">&#9679; LIVE</span>
                    </div>
                  </div>
                </a>
                <div class="position-relative d-block p-4">
                  <!--Date-->
                  <div class="d-flex justify-content-start w-100 pb-3">
                    <small class="text-body-secondary" th:text="${e.getFormattedStartDateTime('dd.MM.yyyy, HH:mm')} + ' - ' + ${e.getFormattedEndDateTime('HH:mm')} + 'z'">Mar 12, 2021</small>
                  </div>
                  <div>
                    <a href="#" th:href="@{/events/} + ${e.eventId}" class="text-reset">
                      <div class="h5 link-multiline" th:text="${e.name}">Title</div>
                    </a>
                  </div>
                </div>
              </article>


              <!--<small class="text-body-secondary" th:text="${e.getFormattedStartDateTime('dd.MM.yyyy, HH:mm')} + ' - ' + ${e.getFormattedEndDateTime('HH:mm')} + 'z'">Mar 12, 2021</small>-->
            </div>
          </div>

          <hr/>

          <div class="h5 mb-4" th:text="#{home.weatherinfo.title}">Weather information</div>

          <div>
            <!-- Tabs -->
            <nav class="mb-4">
              <div class="nav nav-pills nav-fill rounded-pill px-2 py-1 bg-body border shadow-sm" role="tablist">
                <a class="nav-link rounded-pill active" data-bs-toggle="tab" href="#metar-lbsf" role="tab" aria-selected="true" th:text="#{home.weatherinfo.lbsf}">LBSF - Sofia</a>
                <a class="nav-link rounded-pill" data-bs-toggle="tab" href="#metar-lbwn" role="tab" aria-selected="false" tabindex="-1" th:text="#{home.weatherinfo.lbwn}">LBWN - Varna</a>
                <a class="nav-link rounded-pill" data-bs-toggle="tab" href="#metar-lbbg" role="tab" aria-selected="false" tabindex="-1" th:text="#{home.weatherinfo.lbbg}">LBBG - Burgas</a>
                <a class="nav-link rounded-pill" data-bs-toggle="tab" href="#metar-lbpd" role="tab" aria-selected="false" tabindex="-1" th:text="#{home.weatherinfo.lbpd}">LBPD - Plovdiv</a>
                <a class="nav-link rounded-pill" data-bs-toggle="tab" href="#metar-lbgo" role="tab" aria-selected="false" tabindex="-1" th:text="#{home.weatherinfo.lbgo}">LBGO - Gorna</a>
              </div>
            </nav>
            <div class="tab-content">
              <div class="tab-pane fade active show" id="metar-lbsf" role="tabpanel">
                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="fw-bold mb-3" th:text="#{home.metar.lbsf}">Sofia Airport Metar (LBSF)</div>
                    <div id="metarLBSF"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="metar-lbwn" role="tabpanel">
                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="fw-bold mb-3" th:text="#{home.metar.lbwn}">Varna Airport Metar (LBWN)</div>
                    <div id="metarLBWN"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="metar-lbbg" role="tabpanel">
                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="fw-bold mb-3" th:text="#{home.metar.lbbg}">Burgas Airport Metar (LBBG)</div>
                    <div id="metarLBBG"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="metar-lbpd" role="tabpanel">
                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="fw-bold mb-3" th:text="#{home.metar.lbpd}">Plovdiv Airport Metar (LBPD)</div>
                    <div id="metarLBPD"></div>
                  </div>
                </div>
              </div>
              <div class="tab-pane fade" id="metar-lbgo" role="tabpanel">
                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="fw-bold mb-3" th:text="#{home.metar.lbgo}">Gorna Airport Metar (LBGO)</div>
                    <div id="metarLBGO"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-3 mb-3">

          <a href="#" th:href="@{/atc-reservations/create}" class="btn btn-success text-white btn-sm mb-3" sec:authorize="isAuthenticated()" th:if="${@securityChecks.hasUserAuthorizedPositions(session.loggedUser.cid)}">
            <i class="bi bi-plus-circle me-1"></i>
            <span th:text="#{calendar.makereservation}">Make a reservation</span>
          </a>

          <div>
            <div class="h5">
              <span th:text="#{home.bookings.title}">Booked positions</span>
            </div>

            <ul class="nav d-flex justify-content-between">
              <li class="nav-item">
                <a class="nav-link" aria-current="page" onclick="bookingPreviousPage();" href="#">
                  <i class="bi bi-chevron-double-left"></i>
                </a>
              </li>
              <li class="nav-item">
                <div id="currentDateDiv" class="nav-link" style="font-weight: bold !important;" th:text="${currentDate}">24.12.2024</div>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="bookingNextPage();">
                  <i class="bi bi-chevron-double-right"></i>
                </a>
              </li>

              <input id="currentDate" type="hidden" th:value="${currentDate}"/>
            </ul>

            <div id="bookingDiv">
              <div class="text-center" th:if="${#lists.isEmpty(bookings)}">
                <small class="text-muted" th:text="#{home.bookings.notfound}">No bookings</small>
              </div>

              <div th:if="${!#lists.isEmpty(bookings)}" th:remove="tag">
                <table class="table table-hover table-striped table-sm mb-2">
                  <thead>
                    <tr>
                      <th class="fw-bold" th:text="#{home.bookings.position}">Position</th>
                      <th class="fw-bold" th:text="#{home.bookings.from}">From</th>
                      <th class="fw-bold text-end" th:text="#{home.bookings.to}">To</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr th:each="b : ${bookings}">
                      <!--<div th:text="${b}"></div>-->
                      <td class="text-primary">
                        <a href="#" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-html="true" th:classappend="${b.reservationType eq 'Training'} ? 'text-warning' : 'text-primary'"
                           th:data-bs-original-title="${b.reservationType eq 'Training'} ? (#{home.bookings.atcinfo.training(${b.userCid}, ${b.userNames.fullName}, ${b.traineeCid}, ${b.traineeNames.fullName})}) : (#{home.bookings.atcinfo(${b.userCid}, ${b.userNames.fullName})})"
                           th:text="${b.reservationType eq 'Training'} ? (${b.position} + ' (T)') : ${b.position}">LBSF_APP</a>
                      </td>
                      <td th:text="${b.fromTime.getFormattedDateTime('HH:mm')}">19:00</td>
                      <td class="text-end" th:text="${b.toTime.getFormattedDateTime('HH:mm')}">23:00</td>
                    </tr>
                  </tbody>
                </table>

                <div class="text-center text-muted">
                  <small th:text="#{home.bookings.alltimes}">(all times are in UTC (Zulu) time)</small>
                </div>
              </div>
            </div>


            <hr class="my-4"/>
          </div>

          <div>
            <div class="h5">
              <span th:text="#{home.onlineatc}">Online ATC</span>
              <span id="onlineBGControllersCountDiv"></span>
            </div>
            <hr class="my-2"/>

            <!--<div class="h6">Bulgarian FIR</div>-->
            <div id="lbsrCtrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBSR_CTR - 131.225</dt>
                <dd>-</dd>
              </dl>
            </div>
            <div id="lbsrVCtrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBSR_V_CTR - 134.700</dt>
                <dd>-</dd>
              </dl>
            </div>

            <hr class="my-2"/>

            <!--<div class="h6">Sofia Airport</div>-->

            <div id="lbsfAppStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBSF_APP - 123.700</dt>
                <dd>-</dd>
              </dl>
            </div>
            <div id="lbsfTwrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBSF_TWR - 118.100</dt>
                <dd>-</dd>
              </dl>
            </div>

            <hr class="my-2"/>

            <!--<div class="h6">Varna Airport</div>-->

            <div id="lbwnAppStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBWN_APP - 124.600</dt>
                <dd>-</dd>
              </dl>
            </div>
            <dl id="lbwnTwrStatusDiv" class="mb-0">
              <dt>LBWN_TWR - 119.500</dt>
              <dd>-</dd>
            </dl>

            <hr class="my-2"/>

            <!--<div class="h6">Burgas Airport</div>-->

            <div id="lbbgAppStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBBG_APP - 125.100</dt>
                <dd>-</dd>
              </dl>
            </div>
            <div id="lbbgTwrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBBG_TWR - 118.000</dt>
                <dd>-</dd>
              </dl>
            </div>

            <hr class="my-2"/>

            <!--<div class="h6">Other Airports</div>-->
            <div id="lbpdTwrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBPD_TWR - 125.500</dt>
                <dd>-</dd>
              </dl>
            </div>
            <div id="lbgoTwrStatusDiv" class="d-flex align-items-center">
              <dl class="mb-0">
                <dt>LBGO_TWR - 124.500</dt>
                <dd>-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <script type="text/javascript" th:inline="javascript">
        /*<![CDATA[*/
        let metarUrl = /*[[@{/v2/metar}]]*/;
                let onlineBGControllersCountUrl = /*[[@{/atc/bg-online/count}]]*/;
                let lbsrCtrStatusUrl = /*[[@{/atc/status/lbsr-ctr}]]*/;
                let lbsrVCtrStatusUrl = /*[[@{/atc/status/lbsr-v-ctr}]]*/;
                let lbsfTwrStatusUrl = /*[[@{/atc/status/lbsf-twr}]]*/;
                let lbsfTwrTStatusUrl = /*[[@{/atc/status/lbsf-t-twr}]]*/;
                let lbsfAppStatusUrl = /*[[@{/atc/status/lbsf-app}]]*/;
                let lbbgTwrStatusUrl = /*[[@{/atc/status/lbbg-twr}]]*/;
                let lbbgAppStatusUrl = /*[[@{/atc/status/lbbg-app}]]*/;
                let lbwnTwrStatusUrl = /*[[@{/atc/status/lbwn-twr}]]*/;
                let lbwnAppStatusUrl = /*[[@{/atc/status/lbwn-app}]]*/;
                let lbpdTwrStatusUrl = /*[[@{/atc/status/lbpd-twr}]]*/;
                let lbgoTwrStatusUrl = /*[[@{/atc/status/lbgo-twr}]]*/;
                let nextPreviousDateUrl = /*[[@{/api/date}]]*/;
                let getBookingsUrl = /*[[@{/atc/reservations}]]*/;
        /*]]>*/

        function bookingNextPage() {
          let url = nextPreviousDateUrl + '/' + $('#currentDate').val() + '/next';

          $.ajax({
            url: url,
            type: 'get',
            success: function (data)
            {
              $('#currentDateDiv').empty().append(data.nextDate);
              $('#currentDate').val(data.nextDate);

              $.ajax({
                url: getBookingsUrl + '/' + data.nextDate,
                type: 'get',
                success: function (data)
                {
                  $("#bookingDiv").empty().append(data);

                  const tooltipTriggerList2 = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                  tooltipTriggerList2.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                  });
                },
                error: function (xhr, status, error)
                {
                  //                    alert("fail");
                }
              });
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
        }

        function bookingPreviousPage() {
          let url = nextPreviousDateUrl + '/' + $('#currentDate').val() + '/previous';

          $.ajax({
            url: url,
            type: 'get',
            success: function (data)
            {
              $('#currentDateDiv').empty().append(data.previousDate);
              $('#currentDate').val(data.previousDate);

              $.ajax({
                url: getBookingsUrl + '/' + data.previousDate,
                type: 'get',
                success: function (data)
                {
                  $("#bookingDiv").empty().append(data);

                  const tooltipTriggerList2 = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                  tooltipTriggerList2.forEach(function (tooltipTriggerEl) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                  });
                },
                error: function (xhr, status, error)
                {
                  //                    alert("fail");
                }
              });
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
        }

        function getAllMetars() {
          getMetarAtICAO("LBSF", "metarLBSF");
          getMetarAtICAO("LBBG", "metarLBBG");
          getMetarAtICAO("LBWN", "metarLBWN");
          getMetarAtICAO("LBPD", "metarLBPD");
          getMetarAtICAO("LBGO", "metarLBGO");
        }

        function reloadContollerStatus(url, element) {
          return reloadContollerStatus(url, element, false, null);
        }

        function reloadContollerStatus(url, element, shouldHideIfEmpty) {
          $.ajax({
            url: url,
            type: 'get',
            success: function (data)
            {
              $("#" + element).empty().append(data);

              if (shouldHideIfEmpty) {
                //                console.log(data);
                if ($("#positionClosed").length !== 0) {
                  $("#" + element).addClass("d-none");
                } else {
                  $("#" + element).removeClass("d-none");
                }
              }
              //              if (shouldHideIfEmpty) {
              //                if (dat)
              //                $("#" + element).addClass("d-none");
              //              }
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
        }

        function reloadControllerCard(url, element) {
          return reloadControllerCard(url, element, false, null);
        }

        function reloadControllerCard(url, element, shouldHideIfEmpty, affectedDiv) {
          $.ajax({
            url: url,
            type: 'get',
            success: function (data)
            {
              $("#" + element).empty().append(data);

              if (shouldHideIfEmpty) {
                //                console.log(data);
                if ($("#positionClosed").length !== 0) {
                  $("#" + element).addClass("d-none");
                  $("#" + affectedDiv).removeClass("col-xl-6");
                } else {
                  $("#" + element).removeClass("d-none");
                  $("#" + affectedDiv).addClass("col-xl-6");
                }
              }
              //              if (shouldHideIfEmpty) {
              //                if (dat)
              //                $("#" + element).addClass("d-none");
              //              }
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
        }

        function reloadOnlineBGControllersCount() {
          $.ajax({
            url: onlineBGControllersCountUrl,
            type: 'get',
            success: function (data)
            {
              var result = "";
              if (data > 0) {
                result = " - " + data;
              }

              $("#onlineBGControllersCountDiv").empty().append(result);
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
        }

        function reloadSofiaControlCard() {
          reloadContollerStatus(lbsrCtrStatusUrl, "lbsrCtrStatusDiv");
        }

        function reloadSofiaVControlCard() {
          reloadContollerStatus(lbsrVCtrStatusUrl, "lbsrVCtrStatusDiv", true);
        }

        function reloadSofiaTowerCard() {
          reloadContollerStatus(lbsfTwrStatusUrl, "lbsfTwrStatusDiv");
        }

        //        function reloadSofiaTowerTCard() {
        //          reloadContollerStatus(lbsfTwrTStatusUrl, "lbsfTwrStatusDiv");
        //        }

        function reloadSofiaApproachCard() {
          reloadContollerStatus(lbsfAppStatusUrl, "lbsfAppStatusDiv");
        }

        function reloadBurgasTowerCard() {
          reloadContollerStatus(lbbgTwrStatusUrl, "lbbgTwrStatusDiv");
        }

        function reloadBurgasApproachCard() {
          reloadContollerStatus(lbbgAppStatusUrl, "lbbgAppStatusDiv");
        }

        function reloadVarnaTowerCard() {
          reloadContollerStatus(lbwnTwrStatusUrl, "lbwnTwrStatusDiv");
        }

        function reloadVarnaApproachCard() {
          reloadContollerStatus(lbwnAppStatusUrl, "lbwnAppStatusDiv");
        }

        function reloadPlovdivTowerCard() {
          reloadContollerStatus(lbpdTwrStatusUrl, "lbpdTwrStatusDiv");
        }

        function reloadGornaTowerCard() {
          reloadContollerStatus(lbgoTwrStatusUrl, "lbgoTwrStatusDiv");
        }

        function getMetarAtICAO(icao, htmlTagId) {
          $.ajax({
            url: metarUrl + "/" + icao,
            type: 'get',
            success: function (data)
            {
              $("#" + htmlTagId).empty().append(data);
            },
            error: function (xhr, status, error)
            {
              //                    alert("fail");
            }
          });
          return false;
        }

        let refreshIntervalSeconds = 15;
        let refreshOnlinesControllersCountIntervalSeconds = refreshIntervalSeconds;
        let atisRefreshIntervalSeconds = 600; // 10 minutes

        (function () {
          window.setInterval(reloadSofiaControlCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadSofiaVControlCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadSofiaTowerCard, refreshIntervalSeconds * 1000);
          //          window.setInterval(reloadSofiaTowerTCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadSofiaApproachCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadBurgasTowerCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadBurgasApproachCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadVarnaTowerCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadVarnaApproachCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadPlovdivTowerCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadGornaTowerCard, refreshIntervalSeconds * 1000);
          window.setInterval(reloadOnlineBGControllersCount, refreshOnlinesControllersCountIntervalSeconds * 1000);
          window.setInterval(getAllMetars, atisRefreshIntervalSeconds * 1000);
          reloadSofiaControlCard();
          reloadSofiaVControlCard();
          reloadSofiaTowerCard();
          //          reloadSofiaTowerTCard();
          reloadSofiaApproachCard();
          reloadBurgasTowerCard();
          reloadBurgasApproachCard();
          reloadVarnaTowerCard();
          reloadVarnaApproachCard();
          reloadPlovdivTowerCard();
          reloadGornaTowerCard();
          reloadOnlineBGControllersCount();
          getAllMetars();
        })();
      </script>
    </div>
  </body>
</html>